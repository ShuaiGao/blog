(window.webpackJsonp=window.webpackJsonp||[]).push([[61],{388:function(t,s,a){"use strict";a.r(s);var e=a(4),r=Object(e.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"protobuf-使用说明"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#protobuf-使用说明"}},[t._v("#")]),t._v(" protobuf 使用说明")]),t._v(" "),s("p",[t._v("ludo 游戏前后端交互协议")]),t._v(" "),s("p",[t._v("参考文档")]),t._v(" "),s("p",[t._v("https://developers.google.com/protocol-buffers/docs/gotutorial")]),t._v(" "),s("p",[t._v("https://developers.google.com/protocol-buffers/docs/reference/go-generated#package")]),t._v(" "),s("h2",{attrs:{id:"_1-环境配置"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_1-环境配置"}},[t._v("#")]),t._v(" 1. 环境配置")]),t._v(" "),s("p",[t._v("go 语言中使用 protobuf，依赖两个文件"),s("code",[t._v("protoc")]),t._v("和"),s("code",[t._v("protoc-gen-go")]),t._v("，当前文件已经下载到 script 目录")]),t._v(" "),s("ol",[s("li",[t._v("protoc")])]),t._v(" "),s("ul",[s("li",[t._v("版本信息：protoc-3.13.0-osx-x86_64")]),t._v(" "),s("li",[t._v("下载地址：https://github.com/protocolbuffers/protobuf/releases/tag/v3.13.0")])]),t._v(" "),s("ol",{attrs:{start:"2"}},[s("li",[t._v("protoc-gen-go")])]),t._v(" "),s("ul",[s("li",[t._v("版本信息：protoc-gen-go.v1.25.0.darwin.amd64.tar.gz")]),t._v(" "),s("li",[t._v("下载地址：https://github.com/protocolbuffers/protobuf-go/releases/tag/v1.25.0")]),t._v(" "),s("li",[t._v("命令下载：go install google.golang.org/protobuf/cmd/protoc-gen-go")])]),t._v(" "),s("p",[t._v("其中 protoc-gen-go 还有一个 386 版本的，应该是用不到了，amd64 的应该就可以了。proto-gen-go 使用命令下载时，会下载到$GOBIN 目录，我在 readme 环境变量中添加了该配置，若重新配置服务器，不影响使用")]),t._v(" "),s("p",[t._v("手动下载程序需要手动配置环境依赖，或拷贝到$GOBIN 目录")]),t._v(" "),s("h2",{attrs:{id:"_2-前端-protobuf-编译方法"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_2-前端-protobuf-编译方法"}},[t._v("#")]),t._v(" 2. 前端 protobuf 编译方法")]),t._v(" "),s("ul",[s("li",[t._v("目前使用的是导入静态文件的方式")]),t._v(" "),s("li",[t._v("安装 pbjs："),s("code",[t._v("npm i -g protobufjs")])]),t._v(" "),s("li",[t._v("将所有需要的 proto 文件放在一个目录下，执行"),s("code",[t._v("pbjs -t static-module -w commonjs -o noname.js *.proto")]),t._v(" 生成 js 文件")]),t._v(" "),s("li",[t._v("再执行"),s("code",[t._v("pbts -o noname.d.ts noname.js")]),t._v("生成 ts 文件")]),t._v(" "),s("li",[t._v("将生成的 js 文件中第一句"),s("code",[t._v('var $protobuf = require("protobufjs/minimal");')]),t._v("修改为"),s("code",[t._v("var $protobuf = protobuf;")])]),t._v(" "),s("li",[t._v("将生成的 ts 文件中第一句"),s("code",[t._v('import * as $protobuf from "protobufjs";')]),t._v("修改为"),s("code",[t._v('import * as $protobuf from "./protobuf";')])]),t._v(" "),s("li",[t._v("替换工程中对应的 js 文件和 ts 文件即可。")])]),t._v(" "),s("h2",{attrs:{id:"_3-后端使用"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-后端使用"}},[t._v("#")]),t._v(" 3. 后端使用")]),t._v(" "),s("p",[t._v("参照脚本 "),s("a",{attrs:{href:"../update_pb.sh"}},[t._v("gen_proto.sh")]),t._v("使用，在 protoc 命令中不支持使用通配符，要导出的 proto 文件需要手动指定")]),t._v(" "),s("p",[t._v("脚本说明")]),t._v(" "),s("div",{staticClass:"language-shell line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 将项目 script 目录添加到环境变量")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("export")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s("span",{pre:!0,attrs:{class:"token environment constant"}},[t._v("PATH")])]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"'),s("span",{pre:!0,attrs:{class:"token variable"}},[s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("`")]),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("pwd")]),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("`")])]),t._v("/script/:"),s("span",{pre:!0,attrs:{class:"token environment constant"}},[t._v("$PATH")]),t._v('"')]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# protoc 生成命令")]),t._v("\nprotoc "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-I")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("./pb/ "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--go_out")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("./golang/ match/match.proto\nprotoc "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-I")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("./pb/ "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--go_out")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("./golang/ player/player.proto\nprotoc "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-I")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("./pb/ "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--go_out")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("./golang/ player/data_server.proto\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br")])]),s("p",[t._v("修改好 gen_proto.sh 后，在项目目录中可以直接执行文件")]),t._v(" "),s("div",{staticClass:"language-sh line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-sh"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("sh")]),t._v(" gen_proto.sh\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br")])]),s("h3",{attrs:{id:"_3-协议使用约定"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_3-协议使用约定"}},[t._v("#")]),t._v(" 3. 协议使用约定")]),t._v(" "),s("ol",[s("li",[t._v("固定协议头")])]),t._v(" "),s("div",{staticClass:"language-protobuf line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-protobuf"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("syntax")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"proto3"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 使用proto3，与proto2的语法上的最大不同点在于，不用写optional和required了")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("package")]),t._v(" pb"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 包名，不要使用proto，可能会导致一些重名需要在import时起另外一个名字，这里建议统一使用pb")]),t._v("\n\n\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("option")]),t._v(" go_package "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"match/pb"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 生成到目录的路径，这里配置是可选的，但是删掉会有警告，建议添加上")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 这里可以导入其他依赖proto，对于google的一些公共依赖，目录待定")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v('//import "google/protobuf/timestamp.proto";')]),t._v("\n\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br")])]),s("ol",{attrs:{start:"2"}},[s("li",[t._v("变量语法")])]),t._v(" "),s("p",[t._v("这里要注意，protobuf 在生成代码时，对于以小写字母开头、下划线开头、下划线连接方式命名的变量进行了转换，示例如下")]),t._v(" "),s("div",{staticClass:"language-protobuf line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-protobuf"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("message")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("C2S_PlayerJoin")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("int32")]),t._v(" configId "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("int32")]),t._v(" nick_name "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("2")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("int32")]),t._v(" _money_free "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("3")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br")])]),s("p",[t._v("生成后的结构体如下")]),t._v(" "),s("div",{staticClass:"language-go line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-go"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("type")]),t._v(" C2S_PlayerJoin "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("struct")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\tstate         protoimpl"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("MessageState\n\tsizeCache     protoimpl"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("SizeCache\n\tunknownFields protoimpl"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("UnknownFields\n\n\tConfigId   "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("int32")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('`protobuf:"varint,1,opt,name=configId,proto3" json:"configId,omitempty"`')]),t._v("\n\tNickName   "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("int32")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('`protobuf:"varint,2,opt,name=nick_name,json=nickName,proto3" json:"nick_name,omitempty"`')]),t._v("\n\tXMoneyFree "),s("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("int32")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('`protobuf:"varint,3,opt,name=_money_free,json=MoneyFree,proto3" json:"_money_free,omitempty"`')]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br")])]),s("p",[t._v("这样在命名中出现"),s("code",[t._v("configId")]),t._v("和"),s("code",[t._v("config_id")]),t._v("时 GoLand 可能会有错误提示，导出时也会失败，因为导出会对应的变量都是 ConfigId。"),s("strong",[t._v("建议不要以下划线开头命名变量")])]),t._v(" "),s("ol",{attrs:{start:"3"}},[s("li",[t._v("Golang 代码中使用 protobuf")])]),t._v(" "),s("p",[t._v("参照"),s("a",{attrs:{href:"https://developers.google.com/protocol-buffers/docs/gotutorial",target:"_blank",rel:"noopener noreferrer"}},[t._v("protocol-buffers 教程"),s("OutboundLink")],1),t._v(" 中的 "),s("a",{attrs:{href:"https://developers.google.com/protocol-buffers/docs/gotutorial#writing_a_message",target:"_blank",rel:"noopener noreferrer"}},[t._v("写消息"),s("OutboundLink")],1),t._v("和 "),s("a",{attrs:{href:"https://developers.google.com/protocol-buffers/docs/gotutorial#reading_a_message",target:"_blank",rel:"noopener noreferrer"}},[t._v("读消息"),s("OutboundLink")],1)]),t._v(" "),s("h2",{attrs:{id:"_4-go-编码中的使用"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-go-编码中的使用"}},[t._v("#")]),t._v(" 4. Go 编码中的使用")]),t._v(" "),s("p",[t._v("对于 protobuf，有多个库提供支持，在 GoLand 中给出的代码提示有一下几种及更多")]),t._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("github.com/gogo/protobuf\ngithub.com/golang/protobuf\ngoogle.golang.org/golang/protobuf\n...\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br")])]),s("ol",[s("li",[t._v("gogo/protobuf ，该库是这样说的")])]),t._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("gogoprotobuf is a fork of golang/protobuf with extra code generation features.\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br")])]),s("ol",{attrs:{start:"2"}},[s("li",[t._v("golang/protobuf，该库是这样说的")])]),t._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("It has been superseded by the google.golang.org/protobuf module, which contains an updated and simplified API, support for protobuf reflection, and many other improvements. We recommend that new code use the google.golang.org/protobuf module.\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br")])]),s("p",[t._v("gogo 的新增特性并不是很了解，golang 又推荐使用 google.golang.org，在代码中使用"),s("a",{attrs:{href:"https://pkg.go.dev/mod/google.golang.org/protobuf",target:"_blank",rel:"noopener noreferrer"}},[t._v("google.golang.org/golang/protobuf"),s("OutboundLink")],1),t._v(" 的 v1.25.0 版本，当前最新。编码中要注意不要引入其他两个库")]),t._v(" "),s("h2",{attrs:{id:"_5-goland-包依赖更新"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_5-goland-包依赖更新"}},[t._v("#")]),t._v(" 5. GoLand 包依赖更新")]),t._v(" "),s("p",[t._v("使用 go mod 包管理方式")]),t._v(" "),s("p",[t._v("pb 依赖更新，使用 git tag 标识的方式进行，服务端自用的 tag，目前不涉及到前端。tag 版本号约定，v 上线版本.迭代大版本.迭代小版本。")]),t._v(" "),s("ul",[s("li",[t._v("上线版本，在项目上线前使用 0")]),t._v(" "),s("li",[t._v("迭代大版本，自定义吧")]),t._v(" "),s("li",[t._v("小版本，自定义吧")])]),t._v(" "),s("p",[t._v("可使用下面命令打 tag，打完 tag 需要主动推送到 tygit，tag 后面可以删除，不用担心写错，"),s("a",{attrs:{href:"https://git-scm.com/book/zh/v2/Git-%E5%9F%BA%E7%A1%80-%E6%89%93%E6%A0%87%E7%AD%BE",target:"_blank",rel:"noopener noreferrer"}},[t._v("参考链接"),s("OutboundLink")],1)]),t._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v('git tag -a v0.1.0 -m "demo"\n\ngit push origin v0.1.0\n')])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br")])]),s("p",[t._v("更新包是需要修改 go.mod 文件中的版本号，更新到指定的包")]),t._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("tygit.touch4.me/rich-joy/ludo-protobuf v0.1.0\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br")])]),s("p",[t._v("然后使用 tidy 命令更新")]),t._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v("go mod tidy\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br")])])])}),[],!1,null,null,null);s.default=r.exports}}]);